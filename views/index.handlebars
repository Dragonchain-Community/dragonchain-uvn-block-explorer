<div id="loading">
	<span class="spinner-border spinner-border-sm text-primary"></span>
	<span id="loading-details">Loading...</span>
</div>
<div id="node-info" class="d-none">
	<div class="row">
		<div class="col-sm-8">
			<h4>Public ID: <span id="public-id"></span></h4>
		</div>
		<div class="col-sm-4 text-right">
	 		<div id="app-state"></div>
		</div>
	</div>

	<div class="bg-light p-3 border">
		<div class="row mb-2">
			<div class="col-sm-4">			
				<b>Node Level:</b><br/>
				<span id="dc-node-level"></span>
			</div>	

			<div class="col-sm-4">			
				<b>Dragonchain Version:</b><br/>
				<span id="dc-version"></span>			
			</div>

			<div class="col-sm-4">
				<b>Block Height:</b><br/>
				<div id="block-height"></div>
			</div>
		</div>

		<div class="row">
			<div class="col-sm-4">
				<b>Blocks Last 24 Hours:</b><br/>
				<span id="block-count-day"></span>
			</div>

			<div class="col-sm-4">
				<b>Last Block Time:</b><br/>
				<span id="last-block-date"></span>				
			</div>

			<div class="col-sm-4">
				<b>TIME @ Last Block:</b><br/>
				<span id="dc-time-at-last-block"><span>
			</div>
		</div>
	</div>

	<div class="row">
		<div class="col-sm-12 text-center pt-3">
			<ul class="nav nav-pills nav-justified">
				<li class="nav-item">
					<a id="chart-byweek" class="chart-option nav-link" href="#">By Week</a>
				</li>
				<li class="nav-item">
					<a id="chart-byday" class="chart-option nav-link" href="#">By Day</a>
				</li>
				<li class="nav-item">
					<a id="chart-byhour" class="chart-option nav-link" href="#">By Hour</a>
				</li>
			</ul>
		</div>
	</div>

	<div class="row">
		<div class="col-sm-12">
			<div id="chart"></div>
		</div>		
	</div>

	<div class="row">
		<div class="col-sm-12">
			<p><b>Last Block:</b></p>
			<pre class="bg-light border p-2"><code id="last-block"></code></pre>
		</div>
	</div>
</div>

<script>
	var ping = null;

	$(function () {		

		// Initialize 
		if (!config.current_chart)
		{
			config.current_chart = "#chart-byday";
			$(config.current_chart).addClass("active");
		}

		$(".chart-option")			
			.click(function () {
				$(".chart-option").removeClass("active");
				$(this).addClass("active");
				config.current_chart = "#" + $(this).attr("id");
				tools.updateChart();
			})

		google.charts.load('current', {packages: ['corechart', 'bar']});

		if (window.localStorage.credentials_secure)
		{
			tools.getStatus()
				.then(function (data) {

					var dataObj = JSON.parse(data);

					if (dataObj.error)
					{
						tools.redirectToLogin();
					} else {												
						node.public_id = dataObj.status.id;
						node.node_level = dataObj.status.level;
						node.dragonchain_version = dataObj.status.version;

						db.findLastBlock()
							.then(function (result) {
								var start_block_id = 0;

								if (result.docs.length > 0)
								{
									node.last_block = result.docs[0].block;
									node.last_block_id = result.docs[0].block.header.block_id;											
								} else {
									node.last_block_id = 0;
								}

								var ping = function () {										
									try {
										// Get new blocks //
										tools.getBlocks(node.last_block_id, node.last_block_id + config.blocks_per_pull)
											.then(function (new_blocks) {
												if (new_blocks.length > 0)											
												{
													// Update the database //													
													db.addBlocks(new_blocks)
														.then(function () {																		
															// Update last block and chart data //
															tools.updateLastBlock();
															tools.updateBlocksLastDay();
															tools.updateChart();

															tools.setAppState("Last check: " + moment().format("LTS"));

															tools.refreshUI();

															setTimeout(ping, config.ping_delay);
														});
													
												} else {													
													if (!node.initialized)
													{
														node.last_update = moment.utc();								
														node.initialized = true;

														tools.updateLastBlock();
														tools.updateBlocksLastDay();
														tools.updateChart();
													}

													if (node.last_block)
														node.last_block_date = moment(node.last_block.header.timestamp * 1000).format('lll') + "  (" + moment(node.last_block.header.timestamp * 1000).fromNow() + ")";

													tools.setAppState("Last check: " + moment().format("LTS"));

													tools.refreshUI();

													setTimeout(ping, config.ping_delay);
												}
											
											})									
									} catch (e)
									{
										console.log(e)
										setTimeout(ping, config.ping_delay);
									}
									
								}								

								ping();								
								
							}).catch(function (err) {
								console.log(err)						
							})
					}
				})
		
			$("#logout")
				.removeClass("d-none")
				.click(function () {
					window.localStorage.removeItem("credentials_secure")							
					document.location.href = "/login";
				})

		} else {
			document.location.href = "/login";
		}

	});	
	
</script>